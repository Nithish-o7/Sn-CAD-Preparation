<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ServiceNow CAD Prep</title>
<!-- Import Google Font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* --- DARK BLUE THEME & MODERN STYLES --- */
:root {
    --bg-gradient-start: #0f172a; 
    --bg-gradient-end: #1e293b;   
    --card-bg: #1e293b;
    --card-hover: #334155;
    --brand-green: #81B5A1;       
    --brand-green-hover: #5e8e7b;
    --brand-dark: #293E40;
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --border-color: #334155;
    --correct-bg: rgba(16, 185, 129, 0.2);
    --correct-border: #10b981;
    --wrong-bg: rgba(239, 68, 68, 0.2);
    --wrong-border: #ef4444;
    --bookmark-color: #f59e0b;
}

body {
    background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
    color: var(--text-primary);
    font-family: 'Poppins', sans-serif;
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    font-size: 16px;
}

.container {
    background-color: rgba(30, 41, 59, 0.95);
    backdrop-filter: blur(12px);
    padding: 45px;
    border-radius: 24px;
    width: 90%;
    max-width: 850px;
    text-align: center;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    border: 1px solid var(--border-color);
    margin: 30px 0;
    position: relative;
    overflow: hidden;
    z-index: 10;
}

h1 { margin-bottom: 8px; color: #ffffff; font-size: 32px; letter-spacing: -0.5px; font-weight: 700; }
h2.section-title { color: var(--brand-green); font-size: 20px; margin: 35px 0 20px 0; text-align: left; border-bottom: 2px solid var(--border-color); padding-bottom: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
.brand-green { color: var(--brand-green); } 
p.sub-head { color: var(--text-secondary); margin-bottom: 45px; font-size: 16px; font-weight: 300; }
.hidden { display: none !important; }

/* DASHBOARD LIST VIEW */
.list-view { display: grid; grid-template-columns: 1fr; gap: 18px; width: 100%; }
@media (min-width: 768px) { .list-view { grid-template-columns: 1fr 1fr; } .list-item:last-child { grid-column: 1 / -1; } }
.list-item { background: var(--bg-gradient-start); padding: 20px 25px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease; border-left: 5px solid var(--brand-green); border: 1px solid var(--border-color); }
.list-item:hover { transform: translateY(-4px); background: var(--card-hover); border-color: var(--brand-green); }
.list-info { text-align: left; }
.list-info h3 { margin: 0; font-size: 18px; color: #fff; font-weight: 600; }
.list-info p { margin: 4px 0 0 0; font-size: 13px; color: var(--text-secondary); }

.start-btn { padding: 8px 24px; background: linear-gradient(135deg, var(--brand-green), var(--brand-green-hover)); color: #fff; border: none; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; transition: transform 0.2s; }
.start-btn:hover { transform: scale(1.05); }

/* QUIZ INTERFACE */
.quiz-header { background: #0f172a; padding: 15px 25px; border-radius: 16px; font-size: 15px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; font-weight: 600; border: 1px solid var(--border-color); color: var(--brand-green); }
.timer-badge { background: rgba(129, 181, 161, 0.1); padding: 5px 12px; border-radius: 12px; border: 1px solid var(--brand-green); display: flex; align-items: center; gap: 6px; }
.icon-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; }
.progress-container { width: 100%; height: 6px; background: #334155; border-radius: 10px; margin-bottom: 25px; overflow: hidden; }
.progress-bar { height: 100%; background: var(--brand-green); width: 0%; transition: width 0.3s ease; }

.question-box { position: relative; }
.question-box h2 { font-size: 20px; margin-bottom: 30px; line-height: 1.6; text-align: left; font-weight: 500; color: #f1f5f9; padding-right: 40px; }
.bookmark-toggle { position: absolute; top: 0; right: 0; font-size: 24px; color: var(--text-secondary); cursor: pointer; }
.bookmark-toggle.bookmarked { color: var(--bookmark-color); }

.options-list { text-align: left; }
.option-item { background: #0f172a; padding: 18px 22px; margin-bottom: 15px; border-radius: 12px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; font-size: 16px; color: #cbd5e1; position: relative; }
.option-item:hover { background: #1e293b; border-color: var(--brand-green); }
.option-item.selected { background-color: var(--brand-dark); border-color: var(--brand-green); color: white; }
.option-item.correct { background-color: var(--correct-bg) !important; border-color: var(--correct-border) !important; color: #fff; font-weight: 500; }
.option-item.wrong { background-color: var(--wrong-bg) !important; border-color: var(--wrong-border) !important; color: #fff; font-weight: 500; }

.key-hint { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 12px; color: var(--text-secondary); border: 1px solid var(--border-color); padding: 2px 6px; border-radius: 4px; opacity: 0.5; }

.nav-buttons { display: flex; justify-content: space-between; margin-top: 40px; }
.nav-btn { background-color: #334155; color: white; border: none; padding: 12px 30px; border-radius: 12px; cursor: pointer; font-size: 15px; font-weight: 600; }
.nav-btn.primary { background: var(--brand-green); color: #0f172a; }
.nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }

#submit-btn { background: var(--brand-green); color: #0f172a; font-weight: 700; display: none; margin-top: 25px; width: 100%; padding: 16px; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; }

.footer-link { margin-top: 40px; font-size: 14px; border-top: 1px solid var(--border-color); padding-top: 25px; color: var(--text-secondary); }
.footer-link a { color: var(--brand-green); text-decoration: none; font-weight: 600; }

.search-container { margin-bottom: 20px; text-align: left; }
.search-input { width: 100%; padding: 12px 15px; border-radius: 10px; border: 1px solid var(--border-color); background: #0f172a; color: white; font-family: 'Poppins', sans-serif; }

#study-view { max-height: 85vh; overflow-y: auto; text-align: left; }
.study-question-block { background: #0f172a; padding: 25px; border-radius: 16px; margin-bottom: 25px; border: 1px solid var(--border-color); }
.study-question-title { color: var(--brand-green); margin-bottom: 18px; font-size: 17px; font-weight: 600; }
.study-option { background: rgba(255,255,255,0.03); padding: 12px 18px; margin-bottom: 10px; border-radius: 8px; color: #ccc; font-size: 15px; }
.study-option.correct-answer { background-color: var(--correct-bg); border: 1px solid var(--correct-border); color: #10b981; font-weight: 600; }

.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; }
.modal-content { background: #1e293b; padding: 40px; border-radius: 20px; text-align: center; border: 1px solid var(--border-color); max-width: 450px; width: 90%; }
.result-score { font-size: 48px; font-weight: 700; color: var(--brand-green); margin: 10px 0; }
.nav-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 10px; margin-top: 20px; max-height: 400px; overflow-y: auto; }
.nav-item { width: 40px; height: 40px; border-radius: 8px; background: #334155; color: #fff; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 14px; }
.nav-item.current { border: 2px solid #fff; }
.nav-item.answered { background: #3b82f6; }
.nav-item.bookmarked { border: 2px solid var(--bookmark-color); }
.nav-item.review-correct { background: var(--correct-border); }
.nav-item.review-wrong { background: var(--wrong-border); }

#confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2000; }
</style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<!-- DASHBOARD VIEW -->
<div class="container" id="dashboard-view">
    <h1><span class="brand-green">ServiceNow</span> CAD Prep</h1>
    <p class="sub-head">Select a module to begin your training</p>

    <h2 class="section-title">Mock Tests</h2>
    <div class="list-view">
        <div class="list-item">
            <div class="list-info"><h3>Mock Test 1</h3><p>45 Questions</p></div>
            <button class="start-btn" onclick="startQuiz('mock1')">Start</button>
        </div>
        <div class="list-item">
            <div class="list-info"><h3>Mock Test 2</h3><p>45 Questions</p></div>
            <button class="start-btn" onclick="startQuiz('mock2')">Start</button>
        </div>
        <div class="list-item">
            <div class="list-info"><h3>Mock Test 3</h3><p>45 Questions</p></div>
            <button class="start-btn" onclick="startQuiz('mock3')">Start</button>
        </div>
        <div class="list-item" style="border-left-color: #fff;">
            <div class="list-info"><h3 style="color:#ffffff;">Study All Mock Tests</h3><p>Full Reference</p></div>
            <button class="start-btn" style="background: #334155;" onclick="startMockStudyMode()">View</button>
        </div>
    </div>

    <h2 class="section-title">Other MCQs</h2>
    <div class="list-view">
        <div class="list-item">
            <div class="list-info"><h3>Set 1</h3><p>30 Questions</p></div>
            <button class="start-btn" onclick="startQuiz('other1')">Start</button>
        </div>
        <div class="list-item">
            <div class="list-info"><h3>Set 2</h3><p>30 Questions</p></div>
            <button class="start-btn" onclick="startQuiz('other2')">Start</button>
        </div>
        <div class="list-item" style="border-left-color: #fff;">
            <div class="list-info"><h3 style="color:#ffffff;">Study All Other Sets</h3><p>Full Reference</p></div>
            <button class="start-btn" style="background: #334155;" onclick="startOtherStudyMode()">View</button>
        </div>
    </div>

    <div class="footer-link">
        <label style="cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;">
            <input type="checkbox" id="jumble-check" checked style="transform:scale(1.3);"> Randomize Answer Order
        </label>
    </div>
</div>

<!-- QUIZ VIEW -->
<div class="container hidden" id="quiz-view">
    <div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
    
    <div class="quiz-header">
        <div style="display:flex; align-items:center; gap:10px;">
            <button class="icon-btn" onclick="openNavModal()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg></button>
            <span id="q-progress">Q 1/10</span>
        </div>
        <div class="timer-badge">‚è±Ô∏è <span id="timer-display">00:00</span></div>
        <span id="score-display">Score: 0 / 0</span>
    </div>

    <div class="question-box">
        <div class="bookmark-toggle" id="bookmark-btn" onclick="toggleBookmark()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg></div>
        <h2 id="question-text">Loading...</h2>
        <div class="options-list" id="options-container"></div>
        <button id="submit-btn" onclick="submitMultiAnswer()">Submit Answer</button>
    </div>

    <div class="nav-buttons">
        <button class="nav-btn prev" onclick="prevQuestion()">Previous</button>
        <button class="nav-btn primary next" onclick="nextQuestion()">Next</button>
    </div>

    <div class="footer-link"><a href="#" onclick="location.reload()">‚¨Ö Exit to Dashboard</a></div>
</div>

<!-- NAVIGATOR MODAL -->
<div id="nav-modal" class="modal-overlay hidden" onclick="if(event.target === this) closeNavModal()">
    <div class="modal-content">
        <h3 style="color:var(--brand-green);">Question Navigator</h3>
        <div class="nav-grid" id="nav-grid-content"></div>
        <button class="nav-btn" style="margin-top:20px;" onclick="closeNavModal()">Close</button>
    </div>
</div>

<!-- RESULTS MODAL -->
<div id="results-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Quiz Completed!</h2>
        <div class="result-score" id="final-score">0%</div>
        <p id="final-msg">Good effort!</p>
        <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
            <button class="nav-btn primary" onclick="closeResultsModal()">Review Answers</button>
            <button class="nav-btn" id="retake-incorrect-btn" onclick="startRetakeIncorrect()">Retake Incorrect</button>
            <button class="nav-btn" onclick="location.reload()">Back to Dashboard</button>
        </div>
    </div>
</div>

<!-- STUDY VIEW -->
<div class="container hidden" id="study-view">
    <div class="quiz-header"><span>Study Mode</span><button class="nav-btn" onclick="location.reload()">Close</button></div>
    <div class="search-container"><input type="text" id="study-search" class="search-input" placeholder="Search questions..." onkeyup="filterStudyQuestions()"></div>
    <div id="study-content"></div>
</div>

<script>
// Mock Data (Shortened for brevity here, but logic applies to full data)
const mock1Data = [
{"numb": 1, "question": "ServiceNow recommends keeping ______ separate to ensure stability and security.", "options": ["Development and Production Environments", "System Logs and User Data", "Incident Management and Problem Management", "On\u2011premise and Cloud Solutions"], "answer": "Development and Production Environments"},
{"numb": 2, "question": "The CMDB in ServiceNow is used to track and manage IT assets and configuration items.", "options": ["True", "False"], "answer": "True"},
{"numb": 3, "question": "Import Sets in ServiceNow can use ______ to transform data as it is imported.", "options": ["Transform Maps", "Workflow Scripts", "Business Rules", "UI Policies"], "answer": "Transform Maps"},
{"numb": 4, "question": "ServiceNow themes cannot be applied to individual applications, only to the entire instance.", "options": ["True", "False"], "answer": "False"},
{"numb": 5, "question": "What is the primary purpose of UI Builder in ServiceNow?", "options": ["To manage server-side logic", "To design and customize user interfaces", "To configure user roles and permissions", "To generate reports and analytics"], "answer": "To design and customize user interfaces"},
{"numb": 6, "question": "UI Builder provides a ______ interface for designing and customizing user interfaces in ServiceNow.", "options": ["Drag-and-drop", "Text-based", "Command-line", "Script-driven"], "answer": "Drag-and-drop"},
{"numb": 7, "question": "What is ServiceNow primarily used for?", "options": ["Video Editing", "Cloud Storage", "IT Service Management", "Graphic Design"], "answer": "IT Service Management"},
{"numb": 8, "question": "Which feature in ServiceNow helps automate workflows and processes?", "options": ["Service Portal", "Knowledge Management", "Flow Designer", "Reporting"], "answer": "Flow Designer"},
{"numb": 9, "question": "Which of the following are features of REST integration in ServiceNow?", "options": ["Stateless communication", "XML-based messaging", "CRUD operations", "Strong typing"], "answer": "CRUD operations"},
{"numb": 10, "question": "What is the first step in creating a custom user interface in UI Builder?", "options": ["Adding data sources", "Selecting a template", "Defining user roles", "Configuring event handlers"], "answer": "Selecting a template"}
// ... Full data would go here
];
// Full data blocks (mock2Data, mock3Data, other1, other2) would be identical to your original source.
// I've kept logic focused on your specific request.
const mock2Data = [{"numb": 1, "question": "JavaScript variables must be declared with the keyword 'var'.", "options": ["True", "False"], "answer": "False"}];
const mock3Data = [{"numb": 1, "question": "Actions in ServiceNow Flow Designer execute specific tasks.", "options": ["True", "False"], "answer": "True"}];
const otherMcqSet1Data = [{"question": "What does coalesce mean?", "options": ["Match", "Ignore"], "answer": "Match"}];
const otherMcqSet2Data = [{"question": "Is ServiceNow cloud based?", "options": ["Yes", "No"], "answer": "Yes"}];

let currentQuizData = [];
let currentQuestionIndex = 0;
let score = 0;
let userAnswers = {};
let timerInterval;
let quizReviewMode = false;
let bookmarkedQuestions = [];
let incorrectQuestions = []; // Stores the question objects that were answered wrongly

// Load bookmarks
if(localStorage.getItem('sn_bookmarks')) {
    bookmarkedQuestions = JSON.parse(localStorage.getItem('sn_bookmarks'));
}

function startQuiz(testId) {
    let rawData = [];
    if(testId === 'mock1') rawData = mock1Data;
    else if(testId === 'mock2') rawData = mock2Data;
    else if(testId === 'mock3') rawData = mock3Data;
    else if(testId === 'other1') rawData = otherMcqSet1Data;
    else if(testId === 'other2') rawData = otherMcqSet2Data;

    // IMPORTANT: Deep clone the data and strip any 'locked' status from previous attempts
    currentQuizData = rawData.map(q => ({
        ...q,
        locked: false,
        options: [...q.options]
    }));

    const jumble = document.getElementById('jumble-check').checked;
    if (jumble) {
        currentQuizData.sort(() => Math.random() - 0.5);
        currentQuizData.forEach(q => q.options.sort(() => Math.random() - 0.5));
    }

    resetQuizState();
    startTimer(45 * 60);
    loadQuestion();
}

function resetQuizState() {
    currentQuestionIndex = 0;
    score = 0;
    userAnswers = {};
    quizReviewMode = false;
    incorrectQuestions = []; // Reset the "current session's" mistakes

    document.getElementById('dashboard-view').classList.add('hidden');
    document.getElementById('quiz-view').classList.remove('hidden');
    document.getElementById('study-view').classList.add('hidden');
    document.getElementById('results-modal').classList.add('hidden');
}

/**
 * FIXED RETAKE LOGIC
 */
function startRetakeIncorrect() {
    if (incorrectQuestions.length === 0) return;

    // 1. Deep clone the incorrect questions and explicitly reset 'locked' state
    currentQuizData = incorrectQuestions.map(q => ({
        ...q,
        locked: false 
    }));

    // 2. Reset the incorrect list for the NEW attempt
    incorrectQuestions = []; 
    
    // 3. Reset UI and counters
    currentQuestionIndex = 0;
    score = 0;
    userAnswers = {};
    quizReviewMode = false;

    document.getElementById('results-modal').classList.add('hidden');
    updateProgressBar();
    startTimer(45 * 60);
    loadQuestion();
}

function loadQuestion() {
    const q = currentQuizData[currentQuestionIndex];
    const isMultiSelect = Array.isArray(q.answer);

    document.getElementById('q-progress').innerText = `Q ${currentQuestionIndex + 1}/${currentQuizData.length}`;
    document.getElementById('score-display').innerText = quizReviewMode ? "Review Mode" : `Score: ${score} / ${currentQuizData.length}`;

    updateProgressBar();

    const bookmarkBtn = document.getElementById('bookmark-btn');
    const isBookmarked = bookmarkedQuestions.includes(q.question);
    bookmarkBtn.classList.toggle('bookmarked', isBookmarked);
    bookmarkBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="${isBookmarked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>`;

    let qText = q.question.replace(/\n/g, '<br>');
    if (isMultiSelect) qText += "<br><small style='color:var(--brand-green);'>(Select all that apply)</small>";
    document.getElementById('question-text').innerHTML = qText;

    const optionsDiv = document.getElementById('options-container');
    optionsDiv.innerHTML = '';

    q.options.forEach((opt, idx) => {
        const btn = document.createElement('div');
        btn.className = 'option-item';
        btn.innerHTML = `<span>${opt}</span> <span class="key-hint">${idx+1}</span>`;

        if (quizReviewMode) {
            btn.style.pointerEvents = 'none';
            const correctArr = isMultiSelect ? q.answer : [q.answer];
            const userSelection = userAnswers[currentQuestionIndex];
            if (correctArr.includes(opt)) btn.classList.add('correct');
            else if (isMultiSelect ? userSelection?.includes(opt) : userSelection === opt) btn.classList.add('wrong');
        } else {
            btn.onclick = () => handleOptionClick(btn, opt, q.answer, isMultiSelect);
            if (q.locked) {
                btn.style.pointerEvents = 'none';
                const correctArr = isMultiSelect ? q.answer : [q.answer];
                if (correctArr.includes(opt)) btn.classList.add('correct');
                else if (isMultiSelect ? userAnswers[currentQuestionIndex]?.includes(opt) : userAnswers[currentQuestionIndex] === opt) btn.classList.add('wrong');
            } else if (isMultiSelect && userAnswers[currentQuestionIndex]?.includes(opt)) {
                btn.classList.add('selected');
            }
        }
        optionsDiv.appendChild(btn);
    });

    const subBtn = document.getElementById('submit-btn');
    subBtn.style.display = (!quizReviewMode && isMultiSelect && !q.locked) ? 'block' : 'none';
    
    document.querySelector('.prev').disabled = currentQuestionIndex === 0;
    const nextBtn = document.querySelector('.next');
    nextBtn.innerText = (currentQuestionIndex === currentQuizData.length - 1) ? (quizReviewMode ? "Exit Review" : "Finish Quiz") : "Next";
}

function handleOptionClick(elem, selectedOpt, correctAns, isMulti) {
    const q = currentQuizData[currentQuestionIndex];
    if (q.locked) return;

    if (isMulti) {
        if (!userAnswers[currentQuestionIndex]) userAnswers[currentQuestionIndex] = [];
        let current = userAnswers[currentQuestionIndex];
        if (current.includes(selectedOpt)) {
            userAnswers[currentQuestionIndex] = current.filter(x => x !== selectedOpt);
            elem.classList.remove('selected');
        } else {
            current.push(selectedOpt);
            elem.classList.add('selected');
        }
    } else {
        userAnswers[currentQuestionIndex] = selectedOpt;
        q.locked = true;
        if (selectedOpt === correctAns) {
            score++;
            elem.classList.add('correct');
        } else {
            elem.classList.add('wrong');
            // Track mistake for retake
            incorrectQuestions.push({...q});
            
            // Show correct answer
            const allOpts = document.querySelectorAll('.option-item');
            allOpts.forEach(o => {
                if (o.innerText.includes(correctAns)) o.classList.add('correct');
            });
        }
        document.getElementById('score-display').innerText = `Score: ${score} / ${currentQuizData.length}`;
        setTimeout(nextQuestion, 1000);
    }
}

function submitMultiAnswer() {
    const q = currentQuizData[currentQuestionIndex];
    const userAns = userAnswers[currentQuestionIndex] || [];
    const correctAns = q.answer;
    q.locked = true;

    const isCorrect = userAns.length === correctAns.length && userAns.every(v => correctAns.includes(v));

    if (isCorrect) {
        score++;
    } else {
        incorrectQuestions.push({...q});
    }
    loadQuestion();
}

function nextQuestion() {
    if (currentQuestionIndex < currentQuizData.length - 1) {
        currentQuestionIndex++;
        loadQuestion();
    } else {
        if (quizReviewMode) location.reload();
        else finishQuiz();
    }
}

function prevQuestion() {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        loadQuestion();
    }
}

function finishQuiz() {
    clearInterval(timerInterval);
    const percentage = Math.round((score / currentQuizData.length) * 100);
    document.getElementById('final-score').innerText = `${percentage}%`;
    document.getElementById('final-msg').innerText = percentage >= 70 ? "Great job! You passed!" : "Keep studying, you'll get it next time!";
    
    // Toggle the retake button visibility based on mistakes
    document.getElementById('retake-incorrect-btn').style.display = incorrectQuestions.length > 0 ? 'block' : 'none';
    
    if (percentage >= 70) triggerConfetti();
    document.getElementById('results-modal').classList.remove('hidden');
}

function updateProgressBar() {
    const progress = ((currentQuestionIndex + 1) / currentQuizData.length) * 100;
    document.getElementById('progress-bar').style.width = `${progress}%`;
}

function startTimer(duration) {
    clearInterval(timerInterval);
    let timer = duration;
    const display = document.getElementById('timer-display');
    timerInterval = setInterval(() => {
        let mins = Math.floor(timer / 60);
        let secs = timer % 60;
        display.textContent = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
        if (--timer < 0) finishQuiz();
    }, 1000);
}

function openNavModal() {
    const grid = document.getElementById('nav-grid-content');
    grid.innerHTML = '';
    currentQuizData.forEach((q, idx) => {
        const item = document.createElement('div');
        item.className = `nav-item ${idx === currentQuestionIndex ? 'current' : ''} ${userAnswers[idx] ? 'answered' : ''}`;
        if (bookmarkedQuestions.includes(q.question)) item.classList.add('bookmarked');
        item.innerText = idx + 1;
        item.onclick = () => { currentQuestionIndex = idx; loadQuestion(); closeNavModal(); };
        grid.appendChild(item);
    });
    document.getElementById('nav-modal').classList.remove('hidden');
}
function closeNavModal() { document.getElementById('nav-modal').classList.add('hidden'); }
function closeResultsModal() { document.getElementById('results-modal').classList.add('hidden'); quizReviewMode = true; currentQuestionIndex = 0; loadQuestion(); }
function toggleBookmark() {
    const q = currentQuizData[currentQuestionIndex].question;
    if (bookmarkedQuestions.includes(q)) bookmarkedQuestions = bookmarkedQuestions.filter(b => b !== q);
    else bookmarkedQuestions.push(q);
    localStorage.setItem('sn_bookmarks', JSON.stringify(bookmarkedQuestions));
    loadQuestion();
}

// Confetti Helper
function triggerConfetti() {
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const confetti = Array.from({length: 150}, () => ({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height - canvas.height,
        size: Math.random() * 8 + 4,
        speed: Math.random() * 3 + 2,
        color: `hsl(${Math.random() * 360}, 70%, 60%)`
    }));
    function frame() {
        ctx.clearRect(0,0, canvas.width, canvas.height);
        confetti.forEach(c => {
            c.y += c.speed;
            ctx.fillStyle = c.color;
            ctx.fillRect(c.x, c.y, c.size, c.size);
        });
        if (confetti.some(c => c.y < canvas.height)) requestAnimationFrame(frame);
    }
    frame();
}

// Study Mode Search
function filterStudyQuestions() {
    const filter = document.getElementById('study-search').value.toLowerCase();
    document.querySelectorAll('.study-question-block').forEach(block => {
        block.style.display = block.innerText.toLowerCase().includes(filter) ? 'block' : 'none';
    });
}

function startMockStudyMode() { setupStudyView([...mock1Data, ...mock2Data, ...mock3Data]); }
function startOtherStudyMode() { setupStudyView([...otherMcqSet1Data, ...otherMcqSet2Data]); }
function setupStudyView(data) {
    document.getElementById('dashboard-view').classList.add('hidden');
    document.getElementById('study-view').classList.remove('hidden');
    const container = document.getElementById('study-content');
    container.innerHTML = data.map((q, idx) => `
        <div class="study-question-block">
            <h3 class="study-question-title">Q${idx+1}. ${q.question}</h3>
            ${q.options.map(opt => `
                <div class="study-option ${Array.isArray(q.answer) ? (q.answer.includes(opt) ? 'correct-answer' : '') : (opt === q.answer ? 'correct-answer' : '')}">
                    ${Array.isArray(q.answer) ? (q.answer.includes(opt) ? '‚úÖ ' : '') : (opt === q.answer ? '‚úÖ ' : '')} ${opt}
                </div>
            `).join('')}
        </div>
    `).join('');
}
</script>
</body>
</html>
